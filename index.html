<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bienvenido</title>
  <style>
    body {
      font-family: Arial, sans-serif;
    }
    #join-room, #room-options, #create-room, #join-game, #game-room {
      display: none;
    }
    #room-options, #create-room, #join-game, #game-room {
      flex-direction: column;
      gap: 10px;
    }
  </style>
  <!-- Incluir Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
  <!-- Incluir SimplePeer -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/simple-peer/9.10.0/simplepeer.min.js"></script>
</head>
<body>
  <h1>Bienvenido</h1>

  <!-- Sección para unirse -->
  <div id="join-room">
    <input type="text" id="username" placeholder="Introduce tu nombre">
    <button onclick="showRoomOptions()">Continuar</button>
  </div>

  <!-- Opciones de crear o unirse a una mesa -->
  <div id="room-options" style="display: flex;">
    <button onclick="showCreateRoom()">Crear mesa</button>
    <button onclick="showJoinGame()">Entrar a jugar</button>
  </div>

  <!-- Crear una mesa -->
  <div id="create-room">
    <input type="text" id="room-name" placeholder="Nombre de la mesa">
    <input type="text" id="room-password" placeholder="Contraseña de la mesa">
    <button onclick="createRoom()">Crear</button>
  </div>

  <!-- Unirse a un juego -->
  <div id="join-game">
    <div id="room-list"></div>
  </div>

  <!-- Sala de juego -->
  <div id="game-room">
    <video id="localVideo" autoplay muted></video>
    <video id="remoteVideo" autoplay></video>
    <button onclick="leaveRoom()">Abandonar mesa</button>
    <p id="lastToLeaveMessage" style="display: none;">La mesa se eliminará al salir.</p>
  </div>

  <script>
    // Configuración de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDHrSTj1-88cT39dMbKYxSLyO5_fgsws-Y",
      authDomain: "fxbio-c7342.firebaseapp.com",
      databaseURL: "https://fxbio-c7342-default-rtdb.firebaseio.com",
      projectId: "fxbio-c7342",
      storageBucket: "fxbio-c7342.appspot.com",
      messagingSenderId: "1054457224265",
      appId: "1:1054457224265:web:11d180732fec716d60b398",
      measurementId: "G-Y0CB22WCWX"
    };

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    let username;
    let currentRoom;

    function showRoomOptions() {
      username = document.getElementById('username').value;
      if (username) {
        document.getElementById('join-room').style.display = 'none';
        document.getElementById('room-options').style.display = 'flex';
      } else {
        alert('Por favor, introduce un nombre.');
      }
    }

    function showCreateRoom() {
      document.getElementById('room-options').style.display = 'none';
      document.getElementById('create-room').style.display = 'flex';
    }

    function showJoinGame() {
      document.getElementById('room-options').style.display = 'none';
      document.getElementById('join-game').style.display = 'flex';
      fetchRooms();
    }

    function createRoom() {
      const roomName = document.getElementById('room-name').value;
      const roomPassword = document.getElementById('room-password').value;
      if (roomName && roomPassword) {
        currentRoom = roomName;
        const roomData = {
          roomName: roomName,
          roomPassword: roomPassword,
          createdBy: username,
          createdAt: firebase.database.ServerValue.TIMESTAMP
        };
        database.ref('rooms/' + roomName).set(roomData);
        joinRoom();
      } else {
        alert('Por favor, introduce un nombre y una contraseña para la mesa.');
      }
    }

    function fetchRooms() {
      const roomList = document.getElementById('room-list');
      roomList.innerHTML = '';

      database.ref('rooms').on('value', snapshot => {
        roomList.innerHTML = ''; // Clear the list
        snapshot.forEach(roomSnapshot => {
          const roomData = roomSnapshot.val();
          const roomItem = document.createElement('div');
          roomItem.innerHTML = `
            <p>${roomData.roomName}</p>
            <button onclick="joinExistingRoom('${roomData.roomName}')">Unirse</button>
          `;
          roomList.appendChild(roomItem);
        });
      });
    }

    function joinExistingRoom(roomName) {
      currentRoom = roomName;
      joinRoom();
    }

    async function joinRoom() {
      document.getElementById('create-room').style.display = 'none';
      document.getElementById('join-game').style.display = 'none';
      document.getElementById('game-room').style.display = 'flex';

      // Iniciar WebRTC
      const localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      document.getElementById('localVideo').srcObject = localStream;
      const localPeer = new SimplePeer({ initiator: location.hash === '#init', trickle: false, stream: localStream });

      localPeer.on('signal', data => {
        database.ref('rooms/' + currentRoom + '/signals/' + username).set(data);
      });

      database.ref('rooms/' + currentRoom + '/signals').on('child_added', snapshot => {
        const data = snapshot.val();
        if (data.username !== username) {
          localPeer.signal(data);
        }
      });

      localPeer.on('stream', stream => {
        document.getElementById('remoteVideo').srcObject = stream;
      });
    }

    function leaveRoom() {
      database.ref('rooms/' + currentRoom + '/signals/' + username).remove();
      database.ref('rooms/' + currentRoom + '/signals').once('value', snapshot => {
        if (!snapshot.exists()) {
          database.ref('rooms/' + currentRoom).remove();
          document.getElementById('lastToLeaveMessage').style.display = 'none';
        }
      });
      document.getElementById('game-room').style.display = 'none';
      document.getElementById('join-room').style.display = 'flex';
      document.getElementById('lastToLeaveMessage').style.display = 'block';
    }
  </script>
</body>
</html>
